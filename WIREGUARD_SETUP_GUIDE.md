# WireGuard Setup Guide for pocket-tether

This guide explains how WireGuard configuration works and what network setup is required for pocket-tether.

## Table of Contents

1. [WireGuard Configuration Overview](#wireguard-configuration-overview)
2. [Server Configuration](#server-configuration)
3. [Client Configuration](#client-configuration)
4. [Network Setup Requirements](#network-setup-requirements)
5. [Complete Setup Flow](#complete-setup-flow)

## WireGuard Configuration Overview

WireGuard uses simple INI-style configuration files. Each peer (server or client) has a configuration file that defines:
- **Interface section**: This device's private key and IP address
- **Peer section(s)**: Other devices' public keys and how to reach them

### Key Concepts

- **Private Key**: Secret key that identifies this device (never share!)
- **Public Key**: Derived from private key, shared with other peers
- **Endpoint**: The public IP:port where a peer can be reached
- **AllowedIPs**: Which IP ranges should route through this peer

## Server Configuration

### Location

- **Linux**: `/etc/wireguard/wg0.conf`
- **macOS**: `/usr/local/etc/wireguard/wg0.conf`

### Server Config Structure

```ini
[Interface]
# Server's private key (generated during setup)
PrivateKey = <server-private-key>

# Server's IP address in the VPN network
Address = 10.0.0.1/24

# Port WireGuard listens on (default: 51820)
ListenPort = 51820

# Commands to run when interface comes up/down
# These enable IP forwarding and NAT for routing client traffic
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

# Client peers are added here
[Peer]
# Client's public key
PublicKey = <client-public-key>
# Client's IP address in VPN network
AllowedIPs = 10.0.0.2/32

[Peer]
# Additional clients...
PublicKey = <another-client-public-key>
AllowedIPs = 10.0.0.3/32
```

### Server Setup Steps

1. **Generate server keys**:
   ```bash
   wg genkey | tee server_private.key | wg pubkey > server_public.key
   ```

2. **Create config file** with Interface section (see above)

3. **Add client peers** as they connect (or use `setup-wireguard-client.sh`)

4. **Enable IP forwarding**:
   ```bash
   # Linux
   echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
   sysctl -p
   
   # macOS
   sudo sysctl -w net.inet.ip.forwarding=1
   ```

5. **Start WireGuard**:
   ```bash
   sudo wg-quick up wg0
   ```

## Client Configuration

### Location

- **Termux/Client**: `~/.pocket-tether/wg0.conf`

### Client Config Structure

```ini
[Interface]
# Client's private key (generated by setup-wireguard-client.sh)
PrivateKey = <client-private-key>

# Client's IP address in the VPN network
Address = 10.0.0.2/24

[Peer]
# Server's public key
PublicKey = <server-public-key>

# Server's public IP address and port
Endpoint = your-server-ip:51820

# Which IPs should route through the VPN
# 10.0.0.0/24 means all traffic to the VPN network
# You can also use 0.0.0.0/0 to route ALL traffic through VPN
AllowedIPs = 10.0.0.0/24

# Keep connection alive (important for mobile/NAT)
# Sends ping every 25 seconds to maintain connection
PersistentKeepalive = 25
```

### Client Setup Steps

1. **Generate client keys** (or use `setup-wireguard-client.sh`):
   ```bash
   wg genkey | tee client_private.key | wg pubkey > client_public.key
   ```

2. **Get server's public key** from server

3. **Create config file** with Interface and Peer sections (see above)

4. **Copy config** to `~/.pocket-tether/wg0.conf`

5. **Start WireGuard**:
   ```bash
   wg_up  # or wg-quick up wg0
   ```

## Network Setup Requirements

### 1. Static IP Address (Recommended)

**Why**: If your server's IP changes, clients won't be able to connect.

**Options**:

#### Option A: Router DHCP Reservation (Easiest)
1. Access your router's admin panel (usually `192.168.1.1` or `192.168.0.1`)
2. Find "DHCP Reservations" or "Static IP Assignment"
3. Reserve an IP for your server's MAC address
4. Server will always get the same IP from router

#### Option B: Static IP on Server
1. Configure network interface with static IP
2. Set gateway, DNS, subnet mask manually
3. More complex but gives full control

**How to find your router IP**:
```bash
# Linux/macOS
ip route | grep default
# or
route -n get default
```

### 2. Port Forwarding (Required)

**Why**: WireGuard needs to receive incoming connections from the internet.

**What to configure**:
- **External Port**: `51820` (or your chosen WireGuard port)
- **Internal IP**: Your server's local IP (e.g., `192.168.1.100`)
- **Internal Port**: `51820` (same as external)
- **Protocol**: UDP (not TCP!)

**Steps**:

1. **Find your server's local IP**:
   ```bash
   # Linux
   hostname -I | awk '{print $1}'
   # or
   ip addr show | grep "inet " | grep -v 127.0.0.1
   
   # macOS
   ifconfig | grep "inet " | grep -v 127.0.0.1
   ```

2. **Access router admin panel**:
   - Usually at `192.168.1.1` or `192.168.0.1`
   - Look for "Port Forwarding", "Virtual Server", or "NAT Forwarding"

3. **Add port forward rule**:
   ```
   Service Name: WireGuard
   External Port: 51820
   Internal IP: 192.168.1.100  (your server's IP)
   Internal Port: 51820
   Protocol: UDP
   ```

4. **Save and apply**

**Testing port forwarding**:
```bash
# From outside your network (or use online tool)
# Test if port is open
nc -u -v your-public-ip 51820
```

### 3. Firewall Configuration

**Server firewall rules needed**:

#### Linux (ufw)
```bash
sudo ufw allow 51820/udp
sudo ufw allow from 10.0.0.0/24  # Allow VPN network
```

#### Linux (iptables)
```bash
sudo iptables -A INPUT -p udp --dport 51820 -j ACCEPT
sudo iptables -A INPUT -s 10.0.0.0/24 -j ACCEPT
```

#### macOS (pfctl)
```bash
# Edit /etc/pf.conf
pass in proto udp from any to any port 51820
pass in from 10.0.0.0/24 to any
```

#### Router Firewall
- Most routers allow port forwarding to bypass firewall
- If you have a separate firewall, ensure UDP 51820 is allowed

### 4. Public IP Address

**Dynamic DNS (if your IP changes)**:

If your ISP assigns a dynamic public IP, use a Dynamic DNS service:

1. **Sign up for DDNS service** (e.g., DuckDNS, No-IP, Dynu)
2. **Install DDNS client** on server or router
3. **Update client config** to use hostname instead of IP:
   ```ini
   Endpoint = your-server.ddns.net:51820
   ```

**Finding your public IP**:
```bash
curl ifconfig.me
# or
curl icanhazip.com
```

### 5. Network Address Translation (NAT)

**What it does**: Allows VPN clients to access the internet through the server.

**How it works**: The server's `PostUp` commands set up NAT using iptables:
```bash
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

This makes the server act as a gateway, translating client IPs to the server's IP when accessing the internet.

**Requirements**:
- IP forwarding must be enabled (done in server setup)
- Server must have internet access
- NAT rules are automatically added by WireGuard config

## Complete Setup Flow

### Initial Server Setup

1. **Run server setup script**:
   ```bash
   # Linux
   cd server/linux
   sudo bash setup.sh
   
   # macOS
   cd server/macos
   sudo bash setup.sh
   ```

2. **Note the server public key** (displayed during setup)

3. **Configure network**:
   - Set static IP or DHCP reservation
   - Configure port forwarding (UDP 51820)
   - Configure firewall rules

4. **Start WireGuard**:
   ```bash
   sudo wg-quick up wg0
   ```

### Client Setup (Termux + Android App)

1. **Install WireGuard Android app** from Google Play Store

2. **Run Termux setup**:
   ```bash
   cd client
   bash termux-setup.sh
   ```

3. **Run remote server setup** (first time):
   ```bash
   bash remote-setup.sh user@server-ip
   ```

4. **Generate WireGuard client config**:
   ```bash
   bash setup-wireguard-client.sh user@server-ip
   ```
   This will display a QR code for easy import.

5. **Import config into WireGuard app**:
   - Scan the QR code or import the config file
   - Enable the VPN connection in the app

6. **Connect via SSH**:
   ```bash
   source ~/.bashrc
   pt_connect  # or just: pt
   ```

## Troubleshooting

### Client can't connect to server

1. **Check server is running**:
   ```bash
   sudo wg show
   ```

2. **Check port forwarding**:
   - Verify router port forward is configured
   - Test from outside: `nc -u -v your-ip 51820`

3. **Check firewall**:
   ```bash
   # Linux
   sudo ufw status
   sudo iptables -L -n
   ```

4. **Check server logs**:
   ```bash
   # Linux
   sudo journalctl -u wg-quick@wg0 -f
   ```

### Connection drops frequently

1. **Check PersistentKeepalive** in client config (should be 25)
2. **Check mobile network** - some carriers have aggressive NAT
3. **Check server connectivity** - ensure server has stable internet

### Can't access internet through VPN

1. **Check IP forwarding**:
   ```bash
   # Linux
   cat /proc/sys/net/ipv4/ip_forward  # Should be 1
   
   # macOS
   sysctl net.inet.ip.forwarding  # Should be 1
   ```

2. **Check NAT rules**:
   ```bash
   sudo iptables -t nat -L -n -v
   ```

3. **Check routing**:
   ```bash
   ip route show
   ```

## Security Considerations

1. **Private keys**: Never share or commit private keys
2. **Public keys**: Safe to share, used for peer identification
3. **Firewall**: Only allow necessary ports
4. **Key rotation**: Periodically regenerate keys
5. **Access control**: Use firewall rules to restrict VPN access

## Example: Complete Config Files

### Server Config (`/etc/wireguard/wg0.conf`)
```ini
[Interface]
PrivateKey = <server-private-key>
Address = 10.0.0.1/24
ListenPort = 51820

PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

[Peer]
PublicKey = <client1-public-key>
AllowedIPs = 10.0.0.2/32

[Peer]
PublicKey = <client2-public-key>
AllowedIPs = 10.0.0.3/32
```

### Client Config (`~/.pocket-tether/wg0.conf`)
```ini
[Interface]
PrivateKey = <client-private-key>
Address = 10.0.0.2/24

[Peer]
PublicKey = <server-public-key>
Endpoint = 203.0.113.1:51820
AllowedIPs = 10.0.0.0/24
PersistentKeepalive = 25
```

## Quick Reference

| Item | Server | Client |
|------|--------|--------|
| Config Location | `/etc/wireguard/wg0.conf` | `~/.pocket-tether/wg0.conf` (imported into Android app) |
| IP Address | `10.0.0.1/24` | `10.0.0.2/24` (or next available) |
| Listen Port | `51820` | N/A |
| Endpoint | N/A | `server-ip:51820` |
| Keys | Private + Public | Private + Public |
| NAT | Required (PostUp) | N/A |
| IP Forwarding | Required | N/A |
| Management | Command-line (`wg-quick`) | Android app (WireGuard) |

## Additional Resources

- [WireGuard Official Documentation](https://www.wireguard.com/)
- [WireGuard Quick Start](https://www.wireguard.com/quickstart/)
- [Understanding WireGuard](https://www.wireguard.com/protocol/)

